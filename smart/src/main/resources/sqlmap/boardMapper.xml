<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.smart.board.BoardMapper">


<!-- 방명록 등록 -->
<insert id="registerBoard">
{
	call declare 
	begin
	
	insert into board (title, content, writer)
	values ( #{title}, #{content}, #{writer} );
	
	<if test="fileList != null">
	<foreach collection="fileList" item="file">
	insert into board_file(filename, filepath, board_id)
	values ( #{file.filename}, #{file.filepath}, seq_board.currval);
	</foreach>
	</if>

	end
}
</insert>

<sql id="whereSearch">
<if test="keyword != null">
	<choose>
		<when test=" search == 's1' "> <!-- 전체 -->
		where title like '%'|| #{keyword} ||'%'
		or content  like '%'|| #{keyword} ||'%'
		or writer in (select userid from member 
					  where name like '%'|| #{keyword} ||'%') 
		</when>
		<when test=" search == 's2' "> <!-- 제목 -->
		where title like '%'|| #{keyword} ||'%'
		</when>
		<when test=" search == 's3' "> <!-- 내용 -->
		where content like '%'|| #{keyword} ||'%'
		</when>
		<when test=" search == 's4' "> <!-- 작성자 -->
		where writer in (select userid from member 
					  	 where name like '%'|| #{keyword} ||'%') 
		</when>
	
	</choose>
</if>
</sql>

<!-- 방명록 총 건수 조회 -->
<select id="getCountOfBoard" resultType="integer">
select count(*) from board <include refid="whereSearch"/>
</select>

<!-- 방명록 페이지 목록 조회 -->
<select id="getListOfBoard" resultType="board">
select (select count(*) from board_file where board_id = b.id) filecnt, b.* 
from (  select row_number() over(order by id) no, name, b.* 
  		from board b inner join member on writer = userid
  		<include refid="whereSearch" /> ) b
where no between #{beginList} and #{endList}
order by id desc

</select>

</mapper>